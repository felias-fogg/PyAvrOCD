# **OCD Access and how to handle it in SVD files**

Microchip's ATDF files contain the hardware description of their MCUs, including a hint of whether registers should be accessed read-write, read-only, write-only, or not at all by a debugger. This hint is stored in the attribute `ocd-rw` and is relevant for any IDE/GUI during debugging. Unfortunately, the use of this attribute is not entirely consistent and sometimes somewhat ambiguous. A further observation is that the modern parts do not use this attribute at all.

### Write-only versus empty

After going over all ATtiny and ATmega ATDFs in the [current device packs](https://packs.download.microchip.com) (see the output of my Python script below), it turns out that `write-only` is used in only six instances, all within the context of the ATmegaXU2 family. Moreover, these cases correspond to cases where, in all other MCU descriptions, the empty label has been used. It seems to be the case that the intended meaning is "do not read!"

### Types of critical registers

One can categorize the registers marked with `ocd-rw=""` (and `ocd-rw=""`) as follows:

- The **OCD register**, which is called `DWDR`, `OCDR`, or `MONDR`, should definitely not be read because otherwise Microchip's debugging software `pymcuprog` throws an exception.

  For this reason, the address of this register is always extracted independently and applied as a masked register address in each debugger read operation.

- **I/O registers** for USARTs, LIN, USB, and SPI (designated as `UDR`(`n`), `EUDR`, `LINDAT`, `UEDATX`, `UPDATX`, and `SPDR`(`n`)) share input/output data registers, and reading the register has the side effect of clearing the input. For this reason, these I/O registers should not be accessible to the debugger user for reading. Writing is OK, though.

  One should check whether such registers appear without the `ocd-rw=""` attribute in some files and perhaps, if so, patch those files accordingly. I did that, and they are marked in the table below as `-R/W`.

- **Other output registers,** such as `DAC` (AT90PWMX, ATmegaXM1, ATmegaXC1). The register itself is marked as R/W, and, according to the data sheet, there does not seem to be any side effect when reading the register. So, it is unclear to me why the register is marked as write-only.

- **Write-only control registers**, such as `TCCRnC`. Sometimes they are marked as write-only, and at other times, they are not. Should one patch them?

- **Control registers** such as `DIDRn` and `TIFRn`. These registers are read/write and do not appear to have any hidden side effects when accessed. So, it is utterly unclear to me why they are marked at all.

- **Control registers in the ATmegaXC/M1 series** are apparently quite liberally marked with `ocd-rw=""`. For example, all the pin-change interrupt registers are marked. Also, most of the CAN registers are marked. I have no idea why.

### On CAN and PSC registers in ATmegaXC/M1

Going over the critical registers, I conclude the following. It seems that **all** entries are not meaningful. On the other hand, two entries are missing:

- `CANEN1`: Is read-only and in this case only contains 'reserved bits'. No need to protect it!
- `CANIE1`: R/W, contains only resewrved bits. No reason tho protect it.
- `CANSIT1`: Read-only and all bits reserved. No reason to protect it.
- `CANTCON`: Timer control register R/W. No reason to protect it.
- `CANTIM`: Read-only, timer/counter. No reason to protect it.
- `CANTTC`: Same thing
- `CANTEC`: Error counter, read-only. No reason to protect it.
- `CANREC`: Same thing.
- `DAC`: Output register for DAC. No reason to protect it.
- `TCCR1C`: Strobe on writing, reading will not return meaningful data. No reason to protect.
- `PCICR`: The PCI control reg. No reason to protect it.
- `PCMSKn`: PCI mask registers. No need to protect.
- `PCIFR`: PCI flags, no reason to protect.
- `PIM`: PSC interrupt enable, no reason to protect.
- `PMICn`: PSC Control register, no reason to protect.
- `PCTL`: PSC control register, no reason to protect.
- `PCNF`: PSC configuration register, no reason to protect.
- `PSYNC`: PSC configuration register, no reason to protect.

These are the two entries that have not been marked, but should have:

- `SPDR` is not marked by `ocd-rw=""`, but it should be!
- `LINDAT`: Is not marked by `ocd-rw=""`, but should be since reading clears the input register!

### Conclusion

Based on the usage of the "write-only" and "empty" markers, I conclude that the intended meaning of the "empty" marker is "do not read" for the debugger.

To support debugging, I use the `ocd-rw=""` marker to compile a `masked_register` list for each MCU (the harvest.py script does this). This list is applied when the debugger accesses the MCU. So, the debugger and the user will not be able to read anything from these registers. 0x00 is returned instead.  I patched the ATDF files so that the description is extended by something like "(reading impossible)".

As is obvious, for some I/O registers, this mark is missing for some MCUs. I will write patches for those. It is not clear what to do about the ATmegaXC/M1 series. In the end, I decided to write patch files. I still have to test one of these chips with the debugger.

### Critical registers of ATtinys

```
[['ATtiny10', []],
 ['ATtiny102', ['UDR-R/W']],
 ['ATtiny104', ['UDR-R/W']],
 ['ATtiny11', []],
 ['ATtiny12', []],
 ['ATtiny13', ['DWDR']],
 ['ATtiny13A', ['DWDR']],
 ['ATtiny15', []],
 ['ATtiny1604', []],
 ['ATtiny1606', []],
 ['ATtiny1607', []],
 ['ATtiny1614', []],
 ['ATtiny1616', []],
 ['ATtiny1617', []],
 ['ATtiny1624', []],
 ['ATtiny1626', []],
 ['ATtiny1627', []],
 ['ATtiny1634', ['UDR0', 'UDR1']],
 ['ATtiny167', ['LINDAT', 'SPDR', 'DWDR']],
 ['ATtiny20', ['SPDR-R/W']],
 ['ATtiny202', []],
 ['ATtiny204', []],
 ['ATtiny212', []],
 ['ATtiny214', []],
 ['ATtiny2313', ['UDR', 'SPMCSR', 'CLKPR']],
 ['ATtiny2313A', ['UDR', 'SPMCSR', 'CLKPR']],
 ['ATtiny24', ['TCCR1C']],
 ['ATtiny24A', ['TCCR1C']],
 ['ATtiny25', ['DWDR']],
 ['ATtiny26', []],
 ['ATtiny261', ['DWDR']],
 ['ATtiny261A', ['DWDR']],
 ['ATtiny3216', []],
 ['ATtiny3217', []],
 ['ATtiny3224', []],
 ['ATtiny3226', []],
 ['ATtiny3227', []],
 ['ATtiny4', []],
 ['ATtiny40', ['SPDR-R/W']],
 ['ATtiny402', []],
 ['ATtiny404', []],
 ['ATtiny406', []],
 ['ATtiny412', []],
 ['ATtiny414', []],
 ['ATtiny416', []],
 ['ATtiny417', []],
 ['ATtiny424', []],
 ['ATtiny426', []],
 ['ATtiny427', []],
 ['ATtiny4313', ['UDR', 'SPMCSR', 'CLKPR']],
 ['ATtiny43U', []],
 ['ATtiny44', ['TCCR1C']],
 ['ATtiny441', ['UDR1', 'UDR0', 'TCCR1C', 'TCCR2C', 'SPDR-R/W']],
 ['ATtiny44A', ['TCCR1C']],
 ['ATtiny45', ['DWDR']],
 ['ATtiny461', ['DWDR']],
 ['ATtiny461A', ['DWDR']],
 ['ATtiny48', ['TCCR1C', 'SPDR']],
 ['ATtiny5', []],
 ['ATtiny804', []],
 ['ATtiny806', []],
 ['ATtiny807', []],
 ['ATtiny814', []],
 ['ATtiny816', []],
 ['ATtiny817', []],
 ['ATtiny824', []],
 ['ATtiny826', []],
 ['ATtiny827', []],
 ['ATtiny828', ['SPDR', 'TCCR1C', 'UDR']],
 ['ATtiny84', ['TCCR1C']],
 ['ATtiny841', ['UDR1', 'UDR0', 'TCCR1C', 'TCCR2C', 'SPDR-R/W']],
 ['ATtiny84A', ['TCCR1C']],
 ['ATtiny85', ['DWDR']],
 ['ATtiny861', ['DWDR']],
 ['ATtiny861A', ['DWDR']],
 ['ATtiny87', ['LINDAT', 'SPDR', 'DWDR']],
 ['ATtiny88', ['TCCR1C', 'SPDR']],
 ['ATtiny9', []]]

```

### Critical registers for ATmegas

```
[['AT90CAN128', ['OCDR', 'SPDR', 'UDR0', 'UDR1']],
 ['AT90CAN32', ['OCDR', 'SPDR', 'UDR0', 'UDR1']],
 ['AT90CAN64', ['OCDR', 'SPDR', 'UDR0', 'UDR1']],
 ['AT90PWM1', ['TCCR1C', 'SPDR']],
 ['AT90PWM161', ['DACH', 'DACL', 'SPDR']],
 ['AT90PWM216', ['EUDR', 'DAC', 'TCCR1C', 'UDR', 'SPDR']],
 ['AT90PWM2B', ['EUDR', 'DAC', 'TCCR1C', 'UDR', 'SPDR']],
 ['AT90PWM3', ['EUDR', 'DAC', 'TCCR1C', 'UDR', 'SPDR']],
 ['AT90PWM316', ['EUDR', 'DAC', 'TCCR1C', 'UDR', 'SPDR']],
 ['AT90PWM3B', ['EUDR', 'DAC', 'TCCR1C', 'UDR', 'SPDR']],
 ['AT90PWM81', ['DAC', 'SPDR']],
 ['AT90USB1286', ['SPDR', 'UDR1', 'UEDATX', 'OCDR']],
 ['AT90USB1287', ['SPDR', 'UDR1', 'UEDATX', 'UPDATX', 'OCDR']],
 ['AT90USB162', ['SPDR', 'UEDATX', 'DWDR', 'UDR1-Wonly', 'DIDR1-Wonly']],
 ['AT90USB646', ['SPDR', 'UDR1', 'UEDATX', 'UPDATX', 'OCDR']],
 ['AT90USB647', ['SPDR', 'UDR1', 'UEDATX', 'UPDATX', 'OCDR']],
 ['AT90USB82', ['SPDR', 'UEDATX', 'DWDR', 'UDR1-Wonly', 'DIDR1-Wonly']],
 ['ATmega128', ['SPDR', 'UDR0', 'UDR1', 'OCDR']],
 ['ATmega1280',
  ['UDR0', 'UDR1', 'UDR2', 'UDR3', 'SPDR', 'TIFR5', 'TIFR4', 'OCDR']],
 ['ATmega1281', ['UDR0', 'UDR1', 'SPDR', 'TIFR5', 'TIFR4', 'OCDR']],
 ['ATmega1284', ['UDR0', 'UDR1', 'TCCR1C', 'OCDR', 'SPDR']],
 ['ATmega1284P', ['UDR0', 'UDR1', 'TCCR1C', 'OCDR', 'SPDR']],
 ['ATmega1284RFR2', ['UDR0', 'UDR1', 'SPDR', 'TIFR5', 'TIFR4', 'OCDR']],
 ['ATmega128A', ['SPDR', 'UDR0', 'UDR1', 'OCDR']],
 ['ATmega128RFA1', ['UDR0', 'UDR1', 'SPDR', 'TIFR5', 'TIFR4', 'OCDR']],
 ['ATmega128RFR2', ['UDR0', 'UDR1', 'SPDR', 'TIFR5', 'TIFR4', 'OCDR']],
 ['ATmega16', ['SPDR', 'UDR', 'UCSRC', 'OCDR']],
 ['ATmega1608', []],
 ['ATmega1609', []],
 ['ATmega162', ['UDR0', 'UCSR0C', 'UDR1-R/W', 'UCSR1C', 'SPDR', 'OCDR']],
 ['ATmega164A', ['UDR0', 'UDR1', 'OCDR', 'TCCR1C', 'SPDR0', 'SPDR']],
 ['ATmega164P', ['UDR0', 'UDR1', 'OCDR', 'TCCR1C', 'SPDR0', 'SPDR']],
 ['ATmega164PA', ['UDR0', 'UDR1', 'OCDR', 'TCCR1C', 'SPDR0', 'SPDR']],
 ['ATmega165A', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega165P', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega165PA', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega168', ['UDR0', 'TCCR1C', 'SPDR']],
 ['ATmega168A', ['UDR0', 'TCCR1C', 'SPDR']],
 ['ATmega168P', ['UDR0', 'TCCR1C', 'SPDR']],
 ['ATmega168PA', ['UDR0', 'TCCR1C', 'SPDR']],
 ['ATmega168PB', ['UDR0', 'TCCR1C', 'SPDR']],
 ['ATmega169A', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega169P', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega169PA', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega16A', ['SPDR', 'UDR', 'UCSRC', 'OCDR']],
 ['ATmega16HVA', ['SPDR']],
 ['ATmega16HVB', ['SPDR']],
 ['ATmega16HVBrevB', ['SPDR']],
 ['ATmega16M1',
  ['CANEN1',
   'CANIE1',
   'CANSIT1',
   'CANTCON',
   'CANTIM',
   'CANTTC',
   'CANTEC',
   'CANREC',
   'DAC',
   'TCCR1C',
   'LINDAT-R/W',
   'SPDR',
   'PCICR',
   'PCMSK3',
   'PCMSK2',
   'PCMSK1',
   'PCMSK0',
   'PCIFR',
   'PIFR',
   'PIM',
   'PMIC2',
   'PMIC1',
   'PMIC0',
   'PCTL',
   'POC',
   'PCNF',
   'PSYNC']],
 ['ATmega16U2', ['SPDR', 'UEDATX', 'DWDR', 'UDR1-Wonly', 'DIDR1-Wonly']],
 ['ATmega16U4', ['SPDR', 'UDR1', 'OCDR', 'DIDR2', 'UEDATX']],
 ['ATmega2560',
  ['UDR0', 'UDR1', 'UDR2', 'UDR3', 'SPDR', 'TIFR5', 'TIFR4', 'OCDR']],
 ['ATmega2561', ['UDR0', 'UDR1', 'SPDR', 'TIFR5', 'TIFR4', 'OCDR']],
 ['ATmega2564RFR2', ['UDR0', 'UDR1', 'SPDR', 'TIFR5', 'TIFR4', 'OCDR']],
 ['ATmega256RFR2', ['UDR0', 'UDR1', 'SPDR', 'TIFR5', 'TIFR4', 'OCDR']],
 ['ATmega32', ['OCDR', 'SPDR', 'UDR', 'UCSRC']],
 ['ATmega3208', []],
 ['ATmega3209', []],
 ['ATmega324A', ['UDR0', 'UDR1', 'OCDR', 'TCCR1C', 'SPDR0', 'SPDR']],
 ['ATmega324P', ['UDR0', 'UDR1', 'OCDR', 'TCCR1C', 'SPDR0', 'SPDR']],
 ['ATmega324PA', ['UDR0', 'UDR1', 'OCDR', 'TCCR1C', 'SPDR0', 'SPDR']],
 ['ATmega324PB',
  ['UDR0',
   'UDR1',
   'UDR2',
   'OCDR',
   'TCCR1C',
   'TCCR3C',
   'TCCR4C',
   'SPDR0',
   'SPDR1']],
 ['ATmega325', ['UDR0', 'SPDR', 'OCDR']],
 ['ATmega3250', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega3250A', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega3250P', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega3250PA', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega325A', ['UDR0', 'SPDR', 'OCDR']],
 ['ATmega325P', ['UDR0', 'SPDR', 'OCDR']],
 ['ATmega325PA', ['UDR0', 'SPDR', 'OCDR']],
 ['ATmega328', ['UDR0', 'TCCR1C', 'SPDR']],
 ['ATmega328P', ['UDR0', 'TCCR1C', 'SPDR']],
 ['ATmega328PB',
  ['UDR0', 'UDR1', 'TCCR1C', 'TCCR3C', 'TCCR4C', 'SPDR0', 'SPDR1']],
 ['ATmega329', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega3290', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega3290A', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega3290P', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega3290PA', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega329A', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega329P', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega329PA', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega32A', ['SPDR', 'UDR', 'UCSRC']],
 ['ATmega32C1',
  ['CANEN1',
   'CANIE1',
   'CANSIT1',
   'CANTCON',
   'CANTIM',
   'CANTTC',
   'CANTEC',
   'CANREC',
   'DAC',
   'TCCR1C',
   'LINDAT-R/W',
   'SPDR',
   'PCICR',
   'PCMSK3',
   'PCMSK2',
   'PCMSK1',
   'PCMSK0',
   'PCIFR']],
 ['ATmega32HVB', ['SPDR']],
 ['ATmega32HVBrevB', ['SPDR']],
 ['ATmega32M1',
  ['CANEN1',
   'CANIE1',
   'CANSIT1',
   'CANTCON',
   'CANTIM',
   'CANTTC',
   'DAC',
   'TCCR1C',
   'LINDAT-R/W',
   'SPDR',
   'PCICR',
   'PCMSK3',
   'PCMSK2',
   'PCMSK1',
   'PCMSK0',
   'PCIFR',
   'PIFR',
   'PIM',
   'PMIC2',
   'PMIC1',
   'PMIC0',
   'PCTL',
   'POC',
   'PCNF',
   'PSYNC']],
 ['ATmega32U2', ['SPDR', 'UEDATX', 'DWDR', 'UDR1-Wonly', 'DIDR1-Wonly']],
 ['ATmega32U4', ['SPDR', 'UDR1', 'OCDR', 'UEDATX']],
 ['ATmega406', []],
 ['ATmega48', ['UDR0', 'TCCR1C', 'SPDR']],
 ['ATmega4808', []],
 ['ATmega4809', []],
 ['ATmega48A', ['UDR0', 'TCCR1C', 'SPDR']],
 ['ATmega48P', ['UDR0', 'TCCR1C', 'SPDR']],
 ['ATmega48PA', ['UDR0', 'TCCR1C', 'SPDR']],
 ['ATmega48PB', ['UDR0', 'TCCR1C', 'SPDR']],
 ['ATmega64', ['SPDR', 'UDR0', 'UDR1', 'OCDR']],
 ['ATmega640',
  ['UDR0', 'UDR1', 'UDR2', 'UDR3', 'SPDR', 'TIFR5', 'TIFR4', 'OCDR']],
 ['ATmega644', ['UDR0', 'OCDR', 'TCCR1C', 'SPDR']],
 ['ATmega644A', ['UDR0', 'UDR1', 'OCDR', 'TCCR1C', 'SPDR']],
 ['ATmega644P', ['UDR0', 'UDR1', 'OCDR', 'TCCR1C', 'SPDR']],
 ['ATmega644PA', ['UDR0', 'UDR1', 'OCDR', 'TCCR1C', 'SPDR']],
 ['ATmega644RFR2', ['UDR0', 'UDR1', 'SPDR', 'TIFR5', 'TIFR4', 'OCDR']],
 ['ATmega645', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega6450', ['SPDR', 'UDR0', 'OCDR']],
 ['ATmega6450A', ['SPDR', 'UDR0', 'OCDR']],
 ['ATmega6450P', ['SPDR', 'UDR0', 'OCDR']],
 ['ATmega645A', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega645P', ['SPDR', 'OCDR', 'UDR0']],
 ['ATmega649', ['SPDR', 'UDR0', 'OCDR']],
 ['ATmega6490', ['SPDR', 'UDR0', 'OCDR']],
 ['ATmega6490A', ['SPDR', 'UDR0', 'OCDR']],
 ['ATmega6490P', ['SPDR', 'UDR0', 'OCDR']],
 ['ATmega649A', ['SPDR', 'UDR0', 'OCDR']],
 ['ATmega649P', ['SPDR', 'UDR0', 'OCDR']],
 ['ATmega64A', ['SPDR', 'UDR0', 'UDR1', 'OCDR']],
 ['ATmega64C1',
  ['CANEN1',
   'CANIE1',
   'CANSIT1',
   'CANTCON',
   'CANTIML',
   'CANTIMH',
   'CANTTCL',
   'CANTTCH',
   'DACH',
   'DACL',
   'TCCR1C',
   'LINDAT-R/W',
   'SPDR',
   'PCICR',
   'PCMSK3',
   'PCMSK2',
   'PCMSK1',
   'PCMSK0',
   'PCIFR']],
 ['ATmega64HVE2', ['SPDR', 'LINDAT']],
 ['ATmega64M1',
  ['CANEN1',
   'CANIE1',
   'CANSIT1',
   'CANTCON',
   'CANTIM',
   'CANTTC',
   'DAC',
   'TCCR1C',
   'LINDAT-R/W',
   'SPDR',
   'PCICR',
   'PCMSK3',
   'PCMSK2',
   'PCMSK1',
   'PCMSK0',
   'PCIFR',
   'PIFR',
   'PIM',
   'PMIC2',
   'PMIC1',
   'PMIC0',
   'PCTL',
   'POC',
   'PCNF',
   'PSYNC']],
 ['ATmega64RFR2', ['UDR0', 'UDR1', 'SPDR', 'TIFR5', 'TIFR4', 'OCDR']],
 ['ATmega8', ['SPDR', 'UDR', 'UCSRC']],
 ['ATmega808', []],
 ['ATmega809', []],
 ['ATmega8515', ['UDR-R/W', 'SPDR']],
 ['ATmega8535', ['UDR-R/W', 'SPDR']],
 ['ATmega88', ['UDR0', 'TCCR1C', 'SPDR']],
 ['ATmega88A', ['UDR0', 'TCCR1C', 'SPDR']],
 ['ATmega88P', ['UDR0', 'TCCR1C', 'SPDR']],
 ['ATmega88PA', ['UDR0', 'TCCR1C', 'SPDR']],
 ['ATmega88PB', ['UDR0', 'TCCR1C', 'SPDR']],
 ['ATmega8A', ['SPDR', 'UDR', 'UCSRC']],
 ['ATmega8HVA', ['SPDR']],
 ['ATmega8U2', ['SPDR', 'UEDATX', 'DWDR', 'UDR1-Wonly', 'DIDR1-Wonly']]]


```

